<?php/** * HMAC-SHA256 Validator for n8n webhooks *  * Validates incoming webhook requests from n8n using HMAC-SHA256 signature. * Secret must be configured in both n8n (environment variable) and PHP (.env file). */class HMACValidator{    /**     * Validate HMAC signature     *      * @param string $payload Raw request body (JSON string)     * @param string $signature Signature from X-Webhook-Signature header (format: "sha256=HASH")     * @return bool True if valid, false otherwise     */    public static function validate(string $payload, string $signature): bool    {        // Get secret from environment or config        $secret = self::getSecret();                if (empty($secret)) {            error_log("[HMAC] Warning: N8N_WEBHOOK_SECRET not configured");            return false;        }                if (empty($signature)) {            error_log("[HMAC] Warning: No signature provided");            return false;        }                // Remove "sha256=" prefix if present        $signature = str_replace('sha256=', '', $signature);                // Calculate expected HMAC        $expectedHmac = hash_hmac('sha256', $payload, $secret);                // Timing-safe comparison        $isValid = hash_equals($expectedHmac, $signature);                if (!$isValid) {            error_log("[HMAC] Signature mismatch");            error_log("[HMAC] Expected: $expectedHmac");            error_log("[HMAC] Received: $signature");            error_log("[HMAC] Payload: " . substr($payload, 0, 100) . "...");        }                return $isValid;    }        /**     * Get HMAC secret from environment     *      * @return string|null Secret or null if not found     */    private static function getSecret(): ?string    {        // Try environment variable first        $secret = getenv('N8N_WEBHOOK_SECRET');                // Fallback to .env file parsing (simple implementation)        if (empty($secret) && file_exists(__DIR__ . '/../.env')) {            $env = parse_ini_file(__DIR__ . '/../.env');            $secret = $env['N8N_WEBHOOK_SECRET'] ?? null;        }                return $secret;    }        /**     * Generate HMAC signature for outgoing requests (if needed)     *      * @param string $payload JSON payload to sign     * @return string Signature in format "sha256=HASH"     */    public static function generate(string $payload): string    {        $secret = self::getSecret();        $hmac = hash_hmac('sha256', $payload, $secret);        return "sha256=$hmac";    }}