{
  "name": "Portfolio Enrichment v3.0 â€“ Multi-Provider + Dividends",
  "nodes": [
    {
      "parameters": {
        "fields": {
          "values": [
            {
              "name": "APP_BASE_URL",
              "stringValue": "https://portfolio.newwave-media.it"
            },
            {
              "name": "WEBHOOK_SECRET",
              "stringValue": "a1b2c3d4e5f7349012345678901234567890abcdef1234567890abcdef123456"
            }
          ]
        },
        "options": {}
      },
      "name": "Config Variables",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [
        -1328,
        1672
      ],
      "id": "e4c46d2b-09dd-4f5a-95df-5002b74756bd",
      "notes": "IMPORTANTE: Configura WEBHOOK_SECRET (obbligatorio). API keys opzionali (lascia vuoto se non hai)"
    },
    {
      "parameters": {
        "url": "={{$json.APP_BASE_URL}}/api/n8n/portfolio.php",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (compatible; ETF-Portfolio-Manager/2.1; +https://portfolio.newwave-media.it"
            }
          ]
        },
        "options": {}
      },
      "name": "Get Portfolio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -1104,
        1672
      ],
      "id": "46f0c7ec-cff7-4fc2-be90-95a04f4273e6",
      "notes": "Recupera holdings da PHP (HMAC opzionale)"
    },
    {
      "parameters": {
        "jsCode": "// Extract holdings array from API response\nconst holdings = $input.first().json.holdings || [];\nconst config = $input.all()[0].json;\n\nreturn holdings.map(h => ({\n  json: {\n    ...h,\n    APP_BASE_URL: config.APP_BASE_URL,\n    WEBHOOK_SECRET: config.WEBHOOK_SECRET,\n  }\n}));"
      },
      "name": "Extract Holdings",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        1672
      ],
      "id": "3968ebd7-d299-4886-817d-8e15e98f6bcb"
    },
    {
      "parameters": {
        "options": {}
      },
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -656,
        1672
      ],
      "id": "3c6ba4ab-1973-49f1-a350-3a86fc3336e6",
      "notes": "Processa 3 holdings per volta per evitare rate limiting"
    },
    {
      "parameters": {
        "jsCode": "// Preprocess: normalize symbols for various providers\nconst h = $json;\n\n// Normalize ticker for different providers\nconst ticker = h.ticker || '';\nconst yahooSymbol = ticker;\n\nreturn [{\n  json: {\n    portfolio_id: h.portfolio_id || 1,\n    isin: h.isin,\n    ticker: ticker,\n    name: h.name,\n    quantity: h.quantity,\n    avg_price: h.avg_price,\n    current_price: h.current_price,\n    instrument_type: h.instrument_type,\n    asset_class: h.asset_class,\n    sector: h.sector,\n    // Provider-specific symbols\n    yahoo_symbol: yahooSymbol,\n    justetf_isin: h.isin,\n    // Config\n    APP_BASE_URL: h.APP_BASE_URL,\n    WEBHOOK_SECRET: h.WEBHOOK_SECRET,\n  }\n}];"
      },
      "name": "Preprocess Symbols",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -432,
        1288
      ],
      "id": "eb9b9305-41ab-4dce-b88a-f123cd8bd855"
    },
    {
      "parameters": {
        "url": "=https://query1.finance.yahoo.com/v8/finance/chart/{{$json.yahoo_symbol}}?range=5y&interval=1d&events=div&includeAdjustedClose=true",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "name": "Yahoo Finance Price",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -208,
        1288
      ],
      "id": "622aac05-2077-491e-8044-53be23d470de",
      "continueOnFail": true,
      "notes": "Provider 3: Yahoo Finance (gratuito, sempre attivo)"
    },
    {
      "parameters": {
        "url": "=https://www.justetf.com/api/etfs/{{$json.justetf_isin}}/quote?locale=en&currency=EUR",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\""
            }
          ]
        },
        "options": {
          "timeout": 8000
        }
      },
      "name": "JustETF Price",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        240,
        1480
      ],
      "id": "8ae934a7-41f9-47d2-9797-d639a18ccc17",
      "continueOnFail": true,
      "notes": "Provider 4: JustETF (gratuito, per ETF europei)"
    },
    {
      "parameters": {
        "jsCode": "// All providers failed - keep existing price + add new fields as 0\nconst holding = $node['Preprocess Symbols'].json;\n\n// Local classification\nconst name = holding.name.toLowerCase();\nconst instrumentType = holding.instrument_type;\n\nlet asset_class = 'Unknown';\nlet sector = 'Unknown';\n\nif (name.includes('gold') || name.includes('silver') || instrumentType === 'ETC') {\n  asset_class = 'Commodity';\n  sector = name.includes('gold') ? 'Gold' : 'Precious Metals';\n} else if (instrumentType === 'ETF') {\n  asset_class = 'Equity';\n  if (name.includes('dividend')) sector = 'Dividend';\n  else if (name.includes('world') || name.includes('global')) sector = 'Global';\n  else if (name.includes('u.s.') || name.includes('s&p')) sector = 'USA';\n  else if (name.includes('developed')) sector = 'Developed Markets';\n  else sector = 'Mixed';\n} else if (instrumentType === 'Fondo' || instrumentType === 'MUTUALFUND') {\n  asset_class = 'Equity';\n  if (name.includes('biotech')) sector = 'Healthcare';\n  else if (name.includes('robot') || name.includes('tech')) sector = 'Technology';\n  else if (name.includes('dividend')) sector = 'Dividend';\n  else sector = 'Active Fund';\n}\n\nreturn [{\n  json: {\n    portfolio_id: holding.portfolio_id || 1,\n    isin: holding.isin,\n    ticker: holding.ticker,\n    name: holding.name,\n    short_name: '',\n    current_price: holding.current_price,\n    currency: holding.currency || 'EUR',\n    price_source: 'Fallback',\n\n    // Classification\n    asset_class: asset_class,\n    sector: sector,\n    instrument_type: instrumentType,\n    exchange: '',\n\n    // Financial metrics (0)\n    dividend_yield: 0,\n    annual_dividend: 0,\n    dividend_frequency: 'None',\n\n    // Price ranges\n    fifty_two_week_high: 0,\n    fifty_two_week_low: 0,\n    day_high: 0,\n    day_low: 0,\n\n    // Performance (0)\n    ytd_change_percent: 0,\n    one_month_change_percent: 0,\n    three_month_change_percent: 0,\n    one_year_change_percent: 0,\n\n    // Volume & market\n    volume: 0,\n    previous_close: 0,\n\n    // Metadata\n    has_dividends: false,\n    total_dividends_5y: 0,\n    first_trade_date: 0,\n\n    APP_BASE_URL: holding.APP_BASE_URL,\n    WEBHOOK_SECRET: holding.WEBHOOK_SECRET\n  }\n}];"
      },
      "name": "Fallback - Keep Existing",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        1576
      ],
      "id": "00cc6430-5eaf-4026-bc61-3291881aa225",
      "notes": "Se tutti i provider falliscono, mantiene prezzo esistente + classificazione locale"
    },
    {
      "parameters": {
        "amount": 0.5
      },
      "name": "Wait",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        912,
        1384
      ],
      "id": "5b760eac-0c08-40d6-88b1-920d2867ecb2",
      "webhookId": "cc8e4552-2a30-45e3-9a66-10228e2ad5d5",
      "notes": "Delay tra batch per evitare rate limiting"
    },
    {
      "parameters": {},
      "name": "Loop Back",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1136,
        1648
      ],
      "id": "a9fc6144-db9c-482d-b2cc-daca6b78eafe"
    },
    {
      "parameters": {
        "jsCode": "// Aggregate all enriched holdings - Pass object not string\n\n// Prende tutti gli item in ingresso dal ramo \"Done\" di Split In Batches\nconst items = $input.all();\n\n// Se qualcosa Ã¨ andato storto e non arriva nulla, esci\nif (!items.length) {\n  return [];\n}\n\n// Config dal primo item (APP_BASE_URL ecc.)\nconst firstJson = items[0].json || {};\nconst appBaseUrl = firstJson.APP_BASE_URL || 'https://portfolio.newwave-media.it';\n\n// Rimuovi i campi di config e tieni solo l'enrichment per ciascuna holding\nconst holdings = items.map(item => {\n  const {\n    APP_BASE_URL,\n    WEBHOOK_SECRET,\n    ...enrichment\n  } = item.json;\n\n  return enrichment;\n});\n\n// Payload per l'API PHP\nconst payload = {\n  workflow_id: 'portfolio_enrichment_v3.1',\n  timestamp: new Date().toISOString(),\n  holdings\n};\n\n// Per ora usiamo HMAC_DISABLED (validato lato PHP)\nreturn [{\n  json: {\n    APP_BASE_URL: appBaseUrl,\n    payload,          // oggetto, non stringa\n    signature: 'HMAC_DISABLED'\n  }\n}];\n"
      },
      "name": "Aggregate & Sign",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -432,
        1672
      ],
      "id": "0abcf404-c6bd-433d-9b23-2234ab98b86b"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://portfolio.newwave-media.it/api/n8n/enrich.php",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\""
            },
            {
              "name": "X-Webhook-Signature",
              "value": "={{ $json.signature }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "name": "Post Enriched Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -208,
        1672
      ],
      "id": "4a31af76-0bb7-4e4e-b229-79f4695b9627"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 7 * * *"
            },
            {
              "field": "cronExpression",
              "expression": "30 12 * * *"
            },
            {
              "field": "cronExpression",
              "expression": "0 21 * * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -1552,
        1672
      ],
      "id": "ed1e6389-c02a-4b8c-abda-586f00e9b9f6",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "de281cb0-f874-462a-a22a-690e0a9552e8",
              "leftValue": "={{ $json.chart?.result?.[0]?.meta?.regularMarketPrice}}",
              "rightValue": "={{ 0 }}",
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        16,
        1384
      ],
      "id": "d364dede-0278-41b2-b98c-12f856ce80ef",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// Parse Yahoo Finance v8 chart response - COMPLETE DATA EXTRACTION\nconst holding = $node['Preprocess Symbols'].json;\nconst yahooResponse = $json;\n\nlet meta = {};\nlet dividends = {};\nlet priceHistory = {};\n\ntry {\n  const result = yahooResponse.chart.result[0];\n  meta = result.meta || {};\n  dividends = result.events?.dividends || {};\n  priceHistory = {\n    timestamps: result.timestamp || [],\n    quotes: result.indicators?.quote?.[0] || {}\n  };\n} catch (e) {\n  return []; // Trigger fallback\n}\n\n// Get current price\nconst currentPrice = meta.regularMarketPrice || 0;\n\nif (!currentPrice || currentPrice === 0) {\n  return [];\n}\n\n// Calculate dividend yield from historical dividends (last 12 months)\nlet annualDividend = 0;\nconst today = Date.now() / 1000; // Unix timestamp\nconst oneYearAgo = today - (365 * 24 * 60 * 60);\n\nObject.keys(dividends).forEach(timestamp => {\n  if (parseInt(timestamp) >= oneYearAgo) {\n    annualDividend += dividends[timestamp].amount;\n  }\n});\n\nconst dividendYield = currentPrice > 0 ? (annualDividend / currentPrice) * 100 : 0;\n\n// Calculate price change percentage (YTD, 1M, 3M, 1Y)\nconst closePrices = priceHistory.quotes.close || [];\nconst timestamps = priceHistory.timestamps || [];\n\nlet changeData = {\n  ytd_change: 0,\n  one_month_change: 0,\n  three_month_change: 0,\n  one_year_change: 0\n};\n\nif (closePrices.length > 0 && timestamps.length > 0) {\n  const latestPrice = closePrices[closePrices.length - 1];\n  \n  // YTD (from Jan 1st this year)\n  const yearStart = new Date(new Date().getFullYear(), 0, 1).getTime() / 1000;\n  const ytdIndex = timestamps.findIndex(t => t >= yearStart);\n  if (ytdIndex !== -1) {\n    const ytdPrice = closePrices[ytdIndex];\n    changeData.ytd_change = ((latestPrice - ytdPrice) / ytdPrice * 100).toFixed(2);\n  }\n  \n  // 1 Month ago\n  const oneMonthAgo = today - (30 * 24 * 60 * 60);\n  const monthIndex = timestamps.findIndex(t => t >= oneMonthAgo);\n  if (monthIndex !== -1) {\n    const monthPrice = closePrices[monthIndex];\n    changeData.one_month_change = ((latestPrice - monthPrice) / monthPrice * 100).toFixed(2);\n  }\n  \n  // 3 Months ago\n  const threeMonthsAgo = today - (90 * 24 * 60 * 60);\n  const threeMonthIndex = timestamps.findIndex(t => t >= threeMonthsAgo);\n  if (threeMonthIndex !== -1) {\n    const threeMonthPrice = closePrices[threeMonthIndex];\n    changeData.three_month_change = ((latestPrice - threeMonthPrice) / threeMonthPrice * 100).toFixed(2);\n  }\n  \n  // 1 Year ago\n  const yearIndex = timestamps.findIndex(t => t >= oneYearAgo);\n  if (yearIndex !== -1) {\n    const yearPrice = closePrices[yearIndex];\n    changeData.one_year_change = ((latestPrice - yearPrice) / yearPrice * 100).toFixed(2);\n  }\n}\n\n// Classification\nconst name = holding.name.toLowerCase();\nconst instrumentType = meta.instrumentType || holding.instrument_type;\n\nlet asset_class = 'Unknown';\nlet sector = 'Unknown';\n\nif (name.includes('gold') || name.includes('silver') || instrumentType === 'ETC') {\n  asset_class = 'Commodity';\n  sector = name.includes('gold') ? 'Gold' : 'Precious Metals';\n} else if (instrumentType === 'ETF') {\n  asset_class = 'Equity';\n  if (name.includes('dividend') || name.includes('aristocrat')) {\n    sector = 'Dividend';\n  } else if (name.includes('world') || name.includes('global')) {\n    sector = 'Global';\n  } else if (name.includes('u.s.') || name.includes('s&p')) {\n    sector = 'USA';\n  } else if (name.includes('developed')) {\n    sector = 'Developed Markets';\n  } else {\n    sector = 'Mixed';\n  }\n} else if (instrumentType === 'Fondo' || instrumentType === 'MUTUALFUND') {\n  asset_class = 'Equity';\n  if (name.includes('biotech')) sector = 'Healthcare';\n  else if (name.includes('robot') || name.includes('tech')) sector = 'Technology';\n  else if (name.includes('dividend')) sector = 'Dividend';\n  else sector = 'Active Fund';\n}\n\n// Count dividends in last 12 months for frequency detection\nconst dividendCount = Object.keys(dividends).filter(ts => parseInt(ts) >= oneYearAgo).length;\nlet dividendFrequency = 'None';\nif (dividendCount >= 4) dividendFrequency = 'Quarterly';\nelse if (dividendCount >= 2) dividendFrequency = 'Semi-Annual';\nelse if (dividendCount === 1) dividendFrequency = 'Annual';\n\nconst output = {\n  portfolio_id: holding.portfolio_id || 1,   // ðŸ” arriva al DB\n  isin: holding.isin,\n  ticker: holding.ticker,\n  name: meta.longName || holding.name,\n  short_name: meta.shortName || '',\n  current_price: currentPrice,\n  currency: meta.currency || 'EUR',\n  price_source: 'YahooFinance_v8',\n\n  // Classification\n  asset_class: asset_class,\n  sector: sector,\n  instrument_type: instrumentType,\n  exchange: meta.exchangeName || '',\n\n  // Financial metrics\n  dividend_yield: parseFloat(dividendYield.toFixed(2)),\n  annual_dividend: parseFloat(annualDividend.toFixed(4)),\n  dividend_frequency: dividendFrequency,\n\n  // Price ranges\n  fifty_two_week_high: meta.fiftyTwoWeekHigh || 0,\n  fifty_two_week_low: meta.fiftyTwoWeekLow || 0,\n  day_high: meta.regularMarketDayHigh || 0,\n  day_low: meta.regularMarketDayLow || 0,\n\n  // Performance\n  ytd_change_percent: parseFloat(changeData.ytd_change) || 0,\n  one_month_change_percent: parseFloat(changeData.one_month_change) || 0,\n  three_month_change_percent: parseFloat(changeData.three_month_change) || 0,\n  one_year_change_percent: parseFloat(changeData.one_year_change) || 0,\n\n  // Volume & market\n  volume: meta.regularMarketVolume || 0,\n  previous_close: meta.chartPreviousClose || 0,\n\n  // Metadata\n  has_dividends: Object.keys(dividends).length > 0,\n  total_dividends_5y: Object.keys(dividends).length,\n  first_trade_date: meta.firstTradeDate || 0,\n\n  APP_BASE_URL: holding.APP_BASE_URL,\n  WEBHOOK_SECRET: holding.WEBHOOK_SECRET\n};\n\nreturn [{ json: output }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        1192
      ],
      "id": "a5032df5-3de2-4825-be8c-c84aaa719c00",
      "name": "Parse Yahoo"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "371edcc0-0198-4c74-8dfd-a2ff2de2b4f8",
              "leftValue": "={{ $json.latestQuote?.raw }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        464,
        1480
      ],
      "id": "b6b29d74-d8b1-40b8-ae3f-303fd4658988",
      "name": "If1"
    },
    {
      "parameters": {
        "jsCode": "// Parse JustETF response - ENHANCED & COMPLETE\nconst holding = $node['Preprocess Symbols'].json;\nconst justETFResponse = $json;\n\nlet price = 0;\nlet fiftyTwoWeekHigh = 0;\nlet fiftyTwoWeekLow = 0;\nlet previousClose = 0;\nlet dayChange = 0;\n\ntry {\n  const data = typeof justETFResponse === 'string' ? JSON.parse(justETFResponse) : justETFResponse;\n  price = data.latestQuote?.raw || 0;\n  fiftyTwoWeekHigh = data.quoteLowHigh?.high?.raw || 0;\n  fiftyTwoWeekLow = data.quoteLowHigh?.low?.raw || 0;\n  previousClose = data.previousQuote?.raw || 0;\n  dayChange = data.dtdPrc?.raw || 0;\n} catch (e) {\n  return [];\n}\n\nif (!price || price === 0) {\n  return [];\n}\n\n// Local classification\nconst name = holding.name.toLowerCase();\nconst instrumentType = holding.instrument_type;\n\nlet asset_class = 'Unknown';\nlet sector = 'Unknown';\n\nif (name.includes('gold') || name.includes('silver') || instrumentType === 'ETC') {\n  asset_class = 'Commodity';\n  sector = name.includes('gold') ? 'Gold' : 'Precious Metals';\n} else if (instrumentType === 'ETF') {\n  asset_class = 'Equity';\n  if (name.includes('dividend')) sector = 'Dividend';\n  else if (name.includes('world') || name.includes('global')) sector = 'Global';\n  else if (name.includes('u.s.') || name.includes('s&p')) sector = 'USA';\n  else if (name.includes('developed')) sector = 'Developed Markets';\n  else sector = 'Mixed';\n} else if (instrumentType === 'Fondo' || instrumentType === 'MUTUALFUND') {\n  asset_class = 'Equity';\n  if (name.includes('biotech')) sector = 'Healthcare';\n  else if (name.includes('robot') || name.includes('tech')) sector = 'Technology';\n  else if (name.includes('dividend')) sector = 'Dividend';\n  else sector = 'Active Fund';\n}\n\nreturn [{\n  json: {\n    portfolio_id: holding.portfolio_id || 1,\n    isin: holding.isin,\n    ticker: holding.ticker,\n    name: holding.name,\n    short_name: '',\n    current_price: price,\n    currency: 'EUR',\n    price_source: 'JustETF',\n\n    // Classification\n    asset_class: asset_class,\n    sector: sector,\n    instrument_type: instrumentType,\n    exchange: '',\n\n    // Financial metrics\n    dividend_yield: 0,\n    annual_dividend: 0,\n    dividend_frequency: 'None',\n\n    // Price ranges (from JustETF)\n    fifty_two_week_high: fiftyTwoWeekHigh,\n    fifty_two_week_low: fiftyTwoWeekLow,\n    day_high: 0,\n    day_low: 0,\n\n    // Performance\n    ytd_change_percent: dayChange,\n    one_month_change_percent: 0,\n    three_month_change_percent: 0,\n    one_year_change_percent: 0,\n\n    // Volume & market\n    volume: 0,\n    previous_close: previousClose,\n\n    // Metadata\n    has_dividends: false,\n    total_dividends_5y: 0,\n    first_trade_date: 0,\n\n    APP_BASE_URL: holding.APP_BASE_URL,\n    WEBHOOK_SECRET: holding.WEBHOOK_SECRET\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        1384
      ],
      "id": "ca5a8d18-92a6-4e90-9ab1-742febaa1ac1",
      "name": "Parse JustETF"
    },
    {
      "parameters": {
        "jsCode": "// Extract dividends - Forecast + mark as RECEIVED when ex_date arrives\nconst holding = $node['Preprocess Symbols'].json;\nconst yahooResponse = $node['Yahoo Finance Price'].json;\n\nlet dividends = [];\n\ntry {\n  const result = yahooResponse.chart.result[0];\n  const divData = result.events?.dividends || {};\n  const ticker = holding.ticker;\n  const quantity = holding.quantity || 0;\n  \n  const today = Date.now() / 1000;\n  const todayDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\n  const twoYearsAgo = today - (24 * 30 * 24 * 60 * 60);\n  \n  // Step 1: Raccogli dividendi storici per calcoli\n  const historicalDividends = [];\n  \n  Object.keys(divData).forEach(timestamp => {\n    const ts = parseInt(timestamp);\n    \n    if (ts < twoYearsAgo) {\n      return;\n    }\n    \n    const divEvent = divData[timestamp];\n    const amountPerShare = divEvent.amount || 0;\n    \n    historicalDividends.push({\n      amount_per_share: amountPerShare,\n      timestamp: ts\n    });\n  });\n  \n  // Ordina per data\n  historicalDividends.sort((a, b) => a.timestamp - b.timestamp);\n  \n  // Step 2: Genera forecast\n  if (historicalDividends.length >= 4) {\n    // Media ultimi 4\n    const lastFour = historicalDividends.slice(-4);\n    const avgAmount = lastFour.reduce((sum, d) => sum + d.amount_per_share, 0) / 4;\n    \n    // Intervallo medio\n    let totalDays = 0;\n    for (let i = 1; i < lastFour.length; i++) {\n      const diff = (lastFour[i].timestamp - lastFour[i-1].timestamp) / (24 * 60 * 60);\n      totalDays += diff;\n    }\n    const avgIntervalDays = Math.round(totalDays / (lastFour.length - 1));\n    \n    const lastTimestamp = historicalDividends[historicalDividends.length - 1].timestamp;\n    \n    // Genera 4 forecast futuri\n    for (let i = 1; i <= 4; i++) {\n      const nextTimestamp = lastTimestamp + (avgIntervalDays * i * 24 * 60 * 60);\n      const nextExDate = new Date(nextTimestamp * 1000).toISOString().split('T')[0];\n      const nextPaymentDate = new Date((nextTimestamp + 30 * 24 * 60 * 60) * 1000).toISOString().split('T')[0];\n      \n      // Determina status: se ex_date <= oggi â†’ RECEIVED, altrimenti FORECAST\n      const status = nextExDate <= todayDate ? 'RECEIVED' : 'FORECAST';\n      \n      dividends.push({\n        ticker: ticker,\n        status: status,\n        ex_date: nextExDate,\n        payment_date: nextPaymentDate,\n        amount_per_share: parseFloat(avgAmount.toFixed(4)),\n        quantity: quantity,\n        total_amount: parseFloat((avgAmount * quantity).toFixed(2))\n      });\n    }\n  }\n  \n} catch (e) {\n  // Error\n}\n\nif (dividends.length === 0) {\n  return [];\n}\n\nreturn [{\n  json: {\n    dividends: dividends\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16,
        1024
      ],
      "id": "b5c71476-946e-4a61-8c8d-3a3e1edcf9e7",
      "name": "Extract Dividends",
      "notes": "Estrae dividendi storici da Yahoo per singolo holding"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://portfolio.newwave-media.it/api/dividends.php",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (n8n-dividend-sync/1.0)"
            },
            {
              "name": "X-Webhook-Signature",
              "value": "HMAC_DISABLED"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {
          "timeout": 15000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        240,
        1024
      ],
      "id": "0b4ec097-61c7-4fbc-b6de-0492d9d868d0",
      "name": "Push Dividends to DB",
      "notes": "POST dividendi verso /api/dividends.php"
    }
  ],
  "pinData": {},
  "connections": {
    "Config Variables": {
      "main": [
        [
          {
            "node": "Get Portfolio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Portfolio": {
      "main": [
        [
          {
            "node": "Extract Holdings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Holdings": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches": {
      "main": [
        [
          {
            "node": "Aggregate & Sign",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preprocess Symbols",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preprocess Symbols": {
      "main": [
        [
          {
            "node": "Yahoo Finance Price",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Yahoo Finance Price": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract Dividends",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JustETF Price": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fallback - Keep Existing": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Loop Back",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Back": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate & Sign": {
      "main": [
        [
          {
            "node": "Post Enriched Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Config Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Parse Yahoo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "JustETF Price",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Yahoo": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Parse JustETF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fallback - Keep Existing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse JustETF": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Dividends": {
      "main": [
        [
          {
            "node": "Push Dividends to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "5ea90b00-26c2-4a58-875f-497869c0d94f",
  "meta": {
    "instanceId": "fe117d56aad4346ee596609bb8c3079d6edd34e383a675201472f524674346cc"
  },
  "id": "ZViUqqBUZBGc1xnB",
  "tags": []
}